<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Play with React</title>
    <script type="application/javascript" src="https://unpkg.com/react@16.0.0/umd/react.production.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/react-dom@16.0.0/umd/react-dom.production.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/babel-standalone@6.26.0/babel.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
    const rootElement = document.getElementById('root')
    // Create a ES6 class component
    class HeartList extends React.Component {
    constructor(props) {
        super(props);
        this.handleChange = this.handleChange.bind(this);
        this.handleClick = this.handleClick.bind(this);
        this.handleSubmit = this.handleSubmit.bind(this);
        this.state = { count: "", selected: "", sprites: [], delay: 300 };
    }
    
    getHearts(){
        fetch("http://localhost:8080/heartbeat-jay/resources/cst8218.pate0941.heartbeat.heart/",{
        headers: {'Accept': 'application/json', 'Authorization':`Basic ${btoa("111:a")}`}})
        .then(res => res.json())
        .then(resjson => this.setState({sprites: resjson}));
    }
    // It is called by the system
    componentDidMount() {
        this.getHearts();
        this.interval = setInterval(this.tick, this.state.delay);
    }
    componentWillMount(){
        clearInterval(this.interval);
    }
    tick = () => {this.getHearts()};
    handleChange(event,field,index) {
        this.setState({selected: {"index":index, "field":this.state.selected.field, "value": event.target.value}});
    }
    handleClick(event,field,index) {
        this.setState({selected: {"index":index, "field":field, "value": event.target.value}});
    }
    handleSubmit(event) {
        let newItem = this.state.sprites[this.state.selected.index];
        newItem[this.state.selected.field] = this.state.selected.value;
        
            fetch('http://localhost:8080/heartbeat-jay/resources/cst8218.pate0941.heartbeat.heart/${newItem.id}',{
                method: 'PUT',
                headers: {'Content-type': 'application/json', 'Authorization':`Basic ${btoa("111:a")}`},
                body: JSON.stringify(newItem)
                })
                .then(res => {
                    this.setState({
                        selected: {}
                        })
                        this.getHearts();
            });
        event.preventDefault();
    }
    
    
    componentDidUpdate(prevProps, prevState) {
        if (prevState.delay !== this.state.delay) {
            clearInterval(this.interval)
            this.interval = setInterval(this.tick, this.state.delay);
        }
        const ctx = this.refs.canvas.getContext("2d");
        ctx.clearRect(0, 0, this.refs.canvas.width, this.refs.canvas.height);
        this.state.sprites.forEach(item => {
            ctx.fillStyle = "#FF0000";
            ctx.fillRect(item.x, item.y, item.size, item.size)
        });
    }
    
    
    render() {
        const valuesArray = this.state.sprites;
        return (
        <div className="hearts-list">
            <h1>Shows what we can do with react!</h1>
                {valuesArray.map((item,key)=>{return <li key={key}>{item.x} {item.y} {item.size} {item.contractedSize} {item.beatCount} </li>})}      
                <table>
                <tr><th>x</th><th>y</th><th>size</th><th>contractedSize</th><th>beatCount</th>{(this.state.selected.field != null) ? (<th> new {this.state.selected.field}</th>) : null}</tr>
                    {this.state.sprites.map((item,key)=>{
                        return (
                    <tr key={key}>
                        <td><input type="text" name={item.id} value={item.x} onClick={(e)=>this.handleClick(e,"x",key)} onChange={(e)=>this.handleChange(e,"x",key)} /> </td>
                        <td><input type="text" name={item.id} value={item.y} onClick={(e)=>this.handleClick(e,"y",key)} onChange={(e)=>this.handleChange(e,"y",key)} /> </td>
                        <td><input type="text" name={item.id} value={item.size} onClick={(e)=>this.handleClick(e,"size",key)} onChange={(e)=>this.handleChange(e,"size",key)} /> </td>
                        <td><input type="text" name={item.id} value={item.contractedSize} onClick={(e)=>this.handleClick(e,"contractedSize",key)} onChange={(e)=>this.handleChange(e,"contractedSize",key)} /> </td>
                        <td><input type="text" name={item.id} value={item.beatCount} onClick={(e)=>this.handleClick(e,"beatCount",key)} onChange={(e)=>this.handleChange(e,"beatCount",key)} /> </td>
                        {(this.state.selected.index === key) ? (<td><input id="selected" type="text" size="7" name="selected" autoFocus value={this.state.selected.value} onChange={(e)=>this.handleChange(e,this.state.selected.field, key)} /> </td>): null}
                    </tr>
                    );})}
         {(this.state.selected.index != null) ? (<tr><td></td><td></td><td></td><td></td><td></td><td><button type="submit" onClick={(e)=>this.handleSubmit()}>Submit</button></td></tr>): null}
                </table>
            <canvas ref="canvas" width={1000} height={1000} />
        </div>
    );
    }
    }
    
    function App(){
        return(
            <div>
                <HeartList name="Using React!"/>
            </div>
        )
    }
   
    ReactDOM.render(
        <App />,
        rootElement
    )
    </script>
</body>
</html>